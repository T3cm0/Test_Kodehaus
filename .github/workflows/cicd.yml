name: CI/CD Cloud Run (staging â†’ prod con aprobaciÃ³n)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build_test:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fast API smoke (local)
        run: |
          python -c "import fastapi, uvicorn; print('FastAPI:', fastapi.__version__)"

      - name: Build container (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: fastapi-demo:ci-${{ github.sha }}

  deploy_staging:
    name: Deploy a STAGING
    runs-on: ubuntu-latest
    needs: [ build_test ]
    environment: staging
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.DEPLOY_SA }}
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker to use gcloud as a credential helper
        run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build & Push image to Artifact Registry
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/fastapi-demo:${{ github.sha }}
            ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/fastapi-demo:staging

      - name: Deploy Cloud Run (staging)
        run: >
          gcloud run deploy "${{ vars.SERVICE_STAGING }}"
          --image="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/fastapi-demo:${{ github.sha }}"
          --region="${{ vars.GCP_REGION }}"
          --platform=managed
          --allow-unauthenticated
          --port=8080
          --quiet

      - name: Smoke test (staging)
        run: |
          URL=$(gcloud run services describe ${{ vars.SERVICE_STAGING }} --region=${{ vars.GCP_REGION }} --format='value(status.url)')
          echo "Staging URL: $URL"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/healthz")
          if [ "$STATUS" != "200" ]; then
            echo "Smoke test fallÃ³ con cÃ³digo $STATUS"
            exit 1
          fi

  deploy_production:
    name: Deploy a PRODUCCIÃ“N (requiere aprobaciÃ³n QA)
    runs-on: ubuntu-latest
    needs: [ deploy_staging ]
    environment:
      name: production
      url: ${{ steps.prod_url.outputs.url }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.DEPLOY_SA }}
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Deploy Cloud Run (prod)
        id: deploy_prod
        run: >
          gcloud run deploy "${{ vars.SERVICE_PROD }}"
          --image="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/fastapi-demo:${{ github.sha }}"
          --region="${{ vars.GCP_REGION }}"
          --platform=managed
          --allow-unauthenticated
          --port=8080
          --quiet

      - name: Output prod URL
        id: prod_url
        run: |
          URL=$(gcloud run services describe ${{ vars.SERVICE_PROD }} --region=${{ vars.GCP_REGION }} --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Anotar URL en summary
        run: |
          echo "ðŸš€ ProducciÃ³n: ${{ steps.prod_url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
